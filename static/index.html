<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Treadmill</title>
<script defer src="/alpine.min.js"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #1a1a2e; --panel: #16213e; --border: #333;
  --text: #e0e0e0; --accent: #00d4aa; --danger: #ff4757;
  --kv-ctrl: #4ade80; --kv-emu: #c084fc; --motor: #60a5fa;
}
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; touch-action: manipulation; user-select: none; }
body { display: flex; flex-direction: column; max-height: 100vh; overflow: hidden; }

/* Header */
.header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--panel); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.header h1 { font-size: 1.1rem; font-weight: 600; }
.dot { width: 12px; height: 12px; border-radius: 50%; background: var(--danger); transition: background 0.3s; }
.dot.on { background: var(--accent); }

/* Gauges */
.gauges { display: flex; gap: 12px; padding: 16px; flex-shrink: 0; }
.gauge { flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px 12px; text-align: center; }
.gauge-value { font-size: 2.5rem; font-weight: 700; font-variant-numeric: tabular-nums; line-height: 1.1; color: var(--accent); }
.gauge-unit { font-size: 0.85rem; color: #999; margin-top: 2px; }
.gauge-label { font-size: 0.7rem; color: #666; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 4px; }

/* Controls */
.controls { padding: 0 16px 12px; flex-shrink: 0; }
.ctrl-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.ctrl-row label { flex: 1; font-size: 0.85rem; text-align: center; font-variant-numeric: tabular-nums; }
.btn { min-height: 56px; min-width: 72px; border: 1px solid var(--border); border-radius: 8px; background: var(--panel); color: var(--text); font-size: 1.3rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.15s; -webkit-tap-highlight-color: transparent; }
.btn:active { background: #2a3a5e; }
.btn-sm { min-height: 48px; min-width: 0; flex: 1; font-size: 0.85rem; font-weight: 500; }
.mode-toggle { display: flex; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.mode-btn { flex: 1; min-height: 52px; border: none; background: var(--panel); color: #888; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: background 0.15s, color 0.15s; -webkit-tap-highlight-color: transparent; }
.mode-btn.active { background: var(--accent); color: #111; }
.mode-btn.active.emu { background: var(--kv-emu); color: #111; }

/* Log tabs (mobile) */
.tabs { display: flex; border-bottom: 1px solid var(--border); flex-shrink: 0; }
.tab { flex: 1; padding: 10px; text-align: center; font-size: 0.8rem; font-weight: 500; cursor: pointer; border-bottom: 2px solid transparent; color: #888; transition: color 0.2s, border-color 0.2s; -webkit-tap-highlight-color: transparent; }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* Log area */
.log-area { flex: 1; overflow: hidden; display: flex; min-height: 0; }
.log-pane { flex: 1; overflow-y: auto; padding: 8px; font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace; font-size: 0.75rem; line-height: 1.5; overscroll-behavior: contain; }
.log-pane.hidden { display: none; }
.log-entry { white-space: nowrap; }
.log-entry.kv-ctrl { color: var(--kv-ctrl); }
.log-entry.kv-emu { color: var(--kv-emu); }
.log-entry.motor { color: var(--motor); }

/* Desktop: side-by-side logs */
@media (min-width: 768px) {
  .tabs { display: none; }
  .log-area { gap: 1px; background: var(--border); }
  .log-pane { display: flex !important; flex-direction: column; background: var(--bg); }
  .log-pane.hidden { display: flex !important; }
  .log-label { font-size: 0.7rem; color: #666; text-transform: uppercase; padding: 4px 8px; background: var(--panel); flex-shrink: 0; letter-spacing: 0.05em; }
}
@media (max-width: 767px) {
  .log-label { display: none; }
}
</style>
</head>
<body x-data="app()" x-init="init()">

<!-- Header -->
<div class="header">
  <h1>Treadmill</h1>
  <div class="dot" :class="{ on: connected }"></div>
</div>

<!-- Gauges -->
<div class="gauges">
  <div class="gauge">
    <div class="gauge-value" x-text="speedDisplay"></div>
    <div class="gauge-unit">mph</div>
    <div class="gauge-label">Speed</div>
  </div>
  <div class="gauge">
    <div class="gauge-value" x-text="inclineDisplay"></div>
    <div class="gauge-unit">%</div>
    <div class="gauge-label">Incline</div>
  </div>
</div>

<!-- Controls -->
<div class="controls">
  <div class="ctrl-row">
    <button class="btn" @click="setSpeed(-1)">&minus;</button>
    <label>SPD <span x-text="emu_speed"></span></label>
    <button class="btn" @click="setSpeed(1)">+</button>
  </div>
  <div class="ctrl-row">
    <button class="btn" @click="setIncline(-1)">&minus;</button>
    <label>INC <span x-text="emu_incline"></span></label>
    <button class="btn" @click="setIncline(1)">+</button>
  </div>
  <div class="mode-toggle">
    <button class="mode-btn" :class="{ active: proxy }" @click="setMode('proxy')">PROXY</button>
    <button class="mode-btn" :class="{ active: emulate, emu: emulate }" @click="setMode('emulate')">EMULATE</button>
  </div>
</div>

<!-- Log tabs (mobile) -->
<div class="tabs">
  <div class="tab" :class="{ active: activeTab === 'kv' }" @click="activeTab = 'kv'">KV Log</div>
  <div class="tab" :class="{ active: activeTab === 'bin' }" @click="activeTab = 'bin'">Motor Log</div>
</div>

<!-- Logs -->
<div class="log-area">
  <div class="log-pane" :class="{ hidden: activeTab !== 'kv' }" x-ref="kvPane">
    <div class="log-label">KV Log</div>
    <template x-for="e in kvLog" :key="e.id">
      <div class="log-entry" :class="e.source === 'emulate' ? 'kv-emu' : 'kv-ctrl'" x-text="e.text"></div>
    </template>
  </div>
  <div class="log-pane" :class="{ hidden: activeTab !== 'bin' }" x-ref="binPane">
    <div class="log-label">Motor Log</div>
    <template x-for="e in binLog" :key="e.id">
      <div class="log-entry motor" x-text="e.text"></div>
    </template>
  </div>
</div>

<script>
function app() {
  let idCounter = 0;
  return {
    ws: null,
    connected: false,
    proxy: true,
    emulate: false,
    emu_speed: 0,
    emu_incline: 0,
    speed: null,
    incline: null,
    kvLog: [],
    binLog: [],
    activeTab: 'kv',

    get speedDisplay() { return this.speed !== null ? this.speed.toFixed(1) : '--'; },
    get inclineDisplay() { return this.incline !== null ? this.incline.toFixed(1) : '--'; },

    init() {
      this.connect();
    },

    connect() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      this.ws = new WebSocket(`${proto}//${location.host}/ws`);

      this.ws.onopen = () => { this.connected = true; };
      this.ws.onclose = () => {
        this.connected = false;
        setTimeout(() => this.connect(), 2000);
      };
      this.ws.onerror = () => { this.ws.close(); };

      this.ws.onmessage = (evt) => {
        const msg = JSON.parse(evt.data);
        if (msg.type === 'status') {
          this.proxy = msg.proxy;
          this.emulate = msg.emulate;
          this.emu_speed = msg.emu_speed;
          this.emu_incline = msg.emu_incline;
          if (msg.speed !== null) this.speed = msg.speed;
          if (msg.incline !== null) this.incline = msg.incline;
        } else if (msg.type === 'kv') {
          const text = `${msg.ts.toFixed(1).padStart(7)}  ${msg.key.padEnd(8)} ${msg.value}`;
          this.kvLog.push({ id: ++idCounter, text, source: msg.source });
          if (this.kvLog.length > 200) this.kvLog.splice(0, this.kvLog.length - 200);
          this.$nextTick(() => {
            const pane = this.$refs.kvPane;
            if (pane) pane.scrollTop = pane.scrollHeight;
          });
        } else if (msg.type === 'bin') {
          const text = `${msg.ts.toFixed(1).padStart(7)}  ${msg.name.padEnd(8)} ${msg.meaning}`;
          this.binLog.push({ id: ++idCounter, text });
          if (this.binLog.length > 200) this.binLog.splice(0, this.binLog.length - 200);
          // Update gauges from decoded binary frames
          if (msg.name === 'SET_SPD' && msg.meaning.startsWith('spd=')) {
            const v = parseFloat(msg.meaning.split('=')[1]);
            if (!isNaN(v)) this.speed = v;
          } else if (msg.name === 'SET_INC' && msg.meaning.startsWith('inc=')) {
            const v = parseFloat(msg.meaning.split('=')[1]);
            if (!isNaN(v)) this.incline = v;
          }
          this.$nextTick(() => {
            const pane = this.$refs.binPane;
            if (pane) pane.scrollTop = pane.scrollHeight;
          });
        }
      };
    },

    async post(path, body) {
      try {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        return await res.json();
      } catch (e) {
        console.error('POST failed:', path, e);
      }
    },

    setSpeed(delta) {
      this.emu_speed = Math.max(0, Math.min(this.emu_speed + delta, 999));
      this.post('/api/speed', { value: this.emu_speed });
    },

    setIncline(delta) {
      this.emu_incline = Math.max(0, Math.min(this.emu_incline + delta, 99));
      this.post('/api/incline', { value: this.emu_incline });
    },

    setMode(mode) {
      if (mode === 'emulate') {
        this.post('/api/emulate', { enabled: true });
      } else {
        this.post('/api/proxy', { enabled: true });
      }
    },
  };
}
</script>
</body>
</html>
